# Auth Armor Node.js SDK

## 🏁 Installation

You can integrate the AuthArmor SDK into your backend by installing and importing our NPM package:

```bash
# Via NPM
npm i -s autharmor-node-sdk

# Via Yarn
yarn add autharmor-node-sdk
```

## 🚀 Usage

Import the module:

```ts
import AuthArmorSDK from "autharmor-sdk";
```

Instantiate the module by passing in your Auth Armor API Key credentials:

```js
const sdk = new AuthArmorSDK({
  clientId: "your_client_id",
  clientSecret: "your_client_secret",
  webauthnClientId: "your_webauthn_client_id" // optional
});
```

## Methods

### `startEnrollCredentials(options: { username: string, userId: string, timeout?: number })`

This method initiates the process of enrolling new WebAuthn credentials.

- `username`: A string representing the username of the user who is enrolling.
- `userId`: A string representing the ID of the user who is enrolling.
- `timeout`: (optional) A number representing the timeout in seconds. The default value is `30000`.

#### **Returns**

---

A Promise that resolves to an object with the following properties:

```js
{
  register_response: {
    challenge: string,
    timeout_in_seconds: number,
    user_id: string,
    webauthn_options: {
      attestation: string,
      authenticator_attachment: string,
      pub_key_cred_params: [
        {
          alg: number,
          type: string
        }
      ],
      rp: {
        id: string,
        name: string
      },
      timeout_in_seconds: number,
      user: {
        display_name: string,
        id: string,
        name: string
      }
    },
    webauthn_registration_options: {
      rpId: string,
      attestation: string,
      authenticatorSelection: {
        authenticatorAttachment: string,
        userVerification: string
      },
      pubKeyCredParams: [
        {
          alg: number,
          type: string
        }
      ],
      timeout: number,
      user: {
        displayName: string,
        id: string,
        name: string
      }
    }
  },
  status: string
}
```

### `verifyEnrollCredentials(options: EnrollCredentialsRequest)`

This method verifies the signed response of a newly enrolled WebAuthn credential.

- `username`: A string representing the username of the user who is enrolling.
- `userId`: A string representing the ID of the user who is enrolling.
- `signedResponse`: An object representing the signed response of the newly enrolled WebAuthn credential.

The signedResponse object should have the following properties:

```js
{
  attestationObject: string,
  clientDataJSON: string
}
```

#### **Returns**

---

A Promise that resolves to an object with the following properties:

```ts
{
  is_enrolled: boolean,
  status: string
}
```

### `verifyAuthRequest({ requestId: string, token: string, type: string })`

This method is used to verify an authentication request sent by a user from the frontend. The requestId and token fields are required as parameters to verify the request. Both of these values are provided by the frontend SDK, which generates them when a user performs an auth request successfully. Once the user receives these values, they can send them over to the backend to verify using the verifyAuthRequest method.

- `type` - A string that specifies the type of authentication being verified. It can be one of the following values: "AuthArmorAuthenticator", "MagicLink", or "WebAuthn".
- `requestId` - A string representing the unique identifier of the authentication request that was generated by the frontend SDK.
- `token` - A string representing the authentication token that was generated by the frontend SDK.

#### **Returns**

---

A Promise that resolves to an object with the following properties:

```ts
{
  verified: boolean,
  requestDetails: object // Includes info on the verified user
}
```

#### **Example**

---

You can use the `verifyAuthRequest` method to verify that the user authenticated successfully and create a new session:

```js
api.post("/auth/login", async request => {
  const { type, token, requestId } = request.body;

  const authRequest = await sdk.verifyAuthRequest({
    requestId,
    token,
    type
  });

  if (registerRequest.verified) {
    // User authenticated successfully!
    // TODO: Generate a new session for the user
  } else {
    // User failed the verification, throw an error response
  }
});
```

Another example use-case is to use the `verifyAuthRequest` method to verify certain sensitive actions that would require 2FA before performing:

```js
api.post("/wallet/transfer", async request => {
  const { type, token, requestId } = request.body;

  const actionVerification = await sdk.verifyAuthRequest({
    requestId,
    token,
    type
  });

  if (actionVerification.verified) {
    // User has performed 2FA successfully
    // TODO: Transfer money
  } else {
    // User failed the verification, throw an error response
  }
});
```

### `verifyRegisterRequest({ requestId: string, token: string, type: string })`

This method is used to verify an authentication request sent by a user from the frontend. The requestId and token fields are required as parameters to verify the request. Both of these values are provided by the frontend SDK, which generates them when a user performs an auth request successfully. Once the user receives these values, they can send them over to the backend to verify using the verifyAuthRequest method.

- `type` - A string that specifies the type of authentication being verified. It can be one of the following values: "AuthArmorAuthenticator", "MagicLink", or "WebAuthn".
- `requestId` - A string representing the unique identifier of the authentication request that was generated by the frontend SDK.
- `token` - A string representing the authentication token that was generated by the frontend SDK.

#### **Returns**

---

A Promise that resolves to an object with the following properties:

```ts
{
  verified: boolean,
  requestDetails: object // Includes info on the verified user
}
```

#### **Example**

---

```js
api.post("/auth/register", async request => {
  const { type, token, requestId } = request.body;

  const registerRequest = await sdk.verifyRegisterRequest({
    requestId,
    token,
    type
  });

  if (registerRequest.verified) {
    // User was registered successfully!
    // TODO: Example use-case: Insert user in database and generate a new session for the user
  } else {
    // User failed the verification, throw an error response
  }
});
```
